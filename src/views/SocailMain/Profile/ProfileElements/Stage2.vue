<template>
  <div class="row">
    <div class="col-md-2">
      <tab-nav :pills="true" id="tab" class="nav nav-pills basic-info-items list-inline d-block p-0 m-0">
        <tab-nav-items :active="true" id="go-to-general-idea" href="#general-idea" ariaControls="general-idea"
          role="tab" :ariaSelected="true" title="ุชูุฎูุต ุงูููุฑุฉ ุงูุนุงูุฉ ูุงูุณุคุงู ุงูุนุงู" />

        <tab-nav-items :active="false" id="go-to-questions" href="#questions" ariaControls="questions" role="tab"
          :ariaSelected="true" title="ุฃุณุฆูุฉ ูุนุฑููุฉ " />
      </tab-nav>

    </div>

    <div class="col-md-1">
    </div>
    <div class="col-md-9">
      <div class="tab-content">
        <!-- START GENERAL IDEA -->
        <tab-content-item :active="true" id="general-idea" aria-labelled-by="general-idea">
          <h4>ููู ุงูุชุจ ุงููุฎูุต ุงูุนุงูุ ูููู ุฃุญุฏุฏ ุงูุณุคุงู ุงูุนุงู </h4>
          <hr>
          <div class="row">
            <div class="col-12">
              <p>
                ููู ูุงุฏุฉ ููุฑูุกุฉ (ูุชุงุจ) ููุงู ุณุคุงููุง ุนุงููุง ูุณุนู ุงููุชุงุจ ูููุงุดูุ ูููู ูุชูุฑุน ุงููุชุงุจ ุนูู ุดูู ูุตูู ุฃุณุงุณูุฉ ููู
                ุซู ูุจุงุญุซ ุฏุงุฎู ูู ูุตู. ุนูุฏ ุดุฑูุนู ูู ูุฑุงุกุฉ ุงููุชุงุจุ ุนููู ุงููุฑูุฑ ุนูู ููุฏูุฉ ุงููุคูู ููุญุงููุฉ ูุนุฑูุฉ (ุงูุณุคุงู
                ุงูุนุงู) ุงูุฐู ูุณุนู ุงููุชุงุจ ููุฅุฌุงุจุฉ ุนูู.
                <br />
                ุฃูุซูุฉ ๐๐ป
                <br />
                ูุชุงุจ ุฃุบูู ุฑุฌู ูู ุจุงุจู = ูุฏูุฑ ุงูุณุคุงู ุงูุนุงู ุญูู ููููุฉ ุตูุงุนุฉ ุงูุซุฑูุฉ ุงููุงููุฉ ูููุฑุฏ โ
                <br />
                ูุชุงุจ ุณูููููุฌูุฉ ุงูุฌูุงููุฑ = ูุฏูุฑ ุงูุณุคุงู ุงูุนุงู ูู ุงููุชุงุจ ุญูู ูุฏุฑุฉ ุงููุณุคูู ุนูู ุงูุชุญูู ูู ุงูุฌูุงููุฑ ูุงูุดุนูุจ
                ูู ุงููุงุญูุฉ ุงูุณููููุฌูุฉ โ
                <br />

                ููู ุฌุงูุจ ุขุฎุฑุ ููู ูุงุฏุฉ ููุฑูุกุฉ (ูุชุงุจ) ููุงู ุชูุฎูุต ุนุงู ููุฃููุงุฑ ุงูุนุงูุฉ ูุงููุญุงูุฑ ุงูุฃุณุงุณูุฉ ุงูุชู ูุฏูุฑ ุญูููุง
                ุงููุชุงุจ. ููุฌุจ ุนูู ุงููุงุฑุฆ ุฃู ูุณุชุทูุน ุฏุงุฆููุง ุชูุฏูู ููุฎุต ูู ุงููุชุงุจุ ููุณุชุญุณู ุงุณุชุฎุฏุงู ุฃููุงุฑ ุงููุงุชุจ ูุงููุงุธู
                ุจุงุบุชุถุงุจ ูุตูุงุนุฉ ุงูููุฎุตุ ูุง ุชูู ุจุฅุถุงูุฉ ุฃููุงุฑู ูุงุนุชูุงุฏุงุชู ุนูู ุงููุฎูุตุ ุณุชูุนู ุฐูู ุญูู ุชูุชุจ ุงูุฃุทุฑูุญุฉ ุญูู ุชูุฒุฌ
                ููุฎุต ุงููุงุชุจ ูุน ุฃููุงุฑู ูุฅุณูุงุทุงุชู ุงูููุฑูุฉ ููุฎุฒููู ุงููุนุฑูู ูููุงุฑูุชู ูุน ุงููุชุงุจ.
              </p>
            </div>
          </div>
          <div v-if="generalInformations" class="d-flex align-items-center mt-3">
            <div class="post-text ml-3 w-100 row">
              <div class="row">
                <div class="w-100">
                  <p class="mb-0 text-primary" v-if="generalInformations.degree">ุงูุชูููู || {{
                  generalInformations.degree }}</p>
                  <div class="alert alert-success w-100" v-if="generalInformations.reviews">
                    {{ generalInformations.reviews }}
                  </div>
                </div>

                <div class="col-md-12 form-group">
                  <div class="card-post-toolbar text-end"
                    v-if="generalInformations.status == null || generalInformations.status == 'rejected'">
                    <div class="dropdown-toggle" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false"
                      role="button" @click="show = !show">
                      <span class="material-symbols-outlined">
                        more_horiz
                      </span>
                    </div>
                    <div :class="`dropdown-menu dropdown-menu-right ${show ? 'show' : ''}`"
                      aria-labelledby="dropdownMenuButton" style="">
                      <a class="dropdown-item d-flex align-items-center"
                        @click="updateGeneralInformation(generalInformations.id)">
                        <span class="material-symbols-outlined me-2 md-18">
                          edit
                        </span>
                        ุชุนุฏูู
                      </a>
                      <a class="dropdown-item d-flex align-items-center"
                        @click="deleteGeneralInformation(generalInformations.id)">
                        <span class="material-symbols-outlined me-2 md-18">
                          delete
                        </span>
                        ุญุฐู
                      </a>
                    </div>

                  </div>
                  <div class="col-md-12 form-group">
                    <h4 class="form-label"> ุงูุชูุฎูุต ุงูุนุงู</h4>
                    <p class="form-control-plaintext">{{ generalInformations.summary }}</p>
                  </div>

                </div>
                <div class="col-md-12 form-group">
                  <div class="col-md-12 form-group">
                    <h4 class="form-label"> ุงูุณุคุงู ุงูุนุงู </h4>
                    <p class="form-control-plaintext">{{ generalInformations.general_question }}</p>
                  </div>

                </div>
                
                <iq-card v-if="generalInformations.status == null || generalInformations.status == 'rejected'">
                  <template v-slot:body>
                    <button class="btn btn-primary d-block w-100" @click="reviewGeneralInformation">ุทูุจ ุชุฏููู</button>
                  </template>
                </iq-card>
              </div>

            </div>

          </div>

          <div v-else class="d-flex align-items-center mt-3">
            <form @submit.prevent="submitGenralInformationsForm" class="post-text ml-3 w-100 row">
              <div class="form-group">
                <label class="form-label" for="bookGeneralIdea">ุงูููุฑุฉ ุงูุนุงูุฉ</label>
                <textarea v-model="v$.generalInfromationsform.summary.$model" rows="5" placeholder="... ุงูุชุจ ููุฑุฉ ุนุงูุฉ"
                  class="rounded form-control" id="bookGeneralIdea"></textarea>
                <small style="color:red;" v-if="v$.generalInfromationsform.summary.$error">
                  ูุทููุง ูู ุจูุชุงุจุฉ ุชูุฎูุต ุนุฏุฏ ุญุฑููู ุจูู 350  ู 1800
                </small>
              </div>
              <div class="form-group">
                <label class="form-label" for="bookGeneralQuestion">ุณุคุงู ุนุงู </label>
                <textarea v-model="v$.generalInfromationsform.general_question.$model" rows="5"
                  placeholder="... ุงูุชุจ ุณุคุงููุง ุนุงูุงู" class="rounded form-control" id="bookGeneralQuestion"></textarea>
                <small style="color:red;" v-if="v$.generalInfromationsform.general_question.$error">
                  ูู ุจูุชุงุจุฉ ุณุคุงู ุนุงู ูุง ูุฒูุฏ ุนุฏุฏ ุญุฑููุฉ ุนู 250  
                </small>
              </div>

              <input type="submit" value="ุฃุถุงูุฉ" href="javascript:void(0);" class="btn btn-primary d-block mt-3" />
            </form>
          </div>
        </tab-content-item>
        <!-- END GENERAL IDEA -->

        <!-- START QUESTIONS -->
        <tab-content-item :active="false" id="questions" aria-labelled-by="questions">
          <h4>ููู ุงูุชุจ ุณุคุงููุง ูุนุฑููุง</h4>
          <hr>
          <div class="row">
            <div class="col-12">
              <p>
                ุจุนุฏ ุชุญุฏูุฏู ููุณุคุงู ุงูุนุงู ุงูุฐู ูุณุนู ุงููุงุชุจ ููุฅุฌุงุจุฉ ุนูู ูู ุฎูุงู ูุชุงุจูุ ูุฅูู ูุงุจุฏ ูุฏ ูุงุญุธุช ูุฌูุฏ ุฃุณุฆูุฉ ูุฑุนูุฉ
                ุฏุงุฎู ูู ูุตู ูู ูุตูู ุงููุชุงุจ. ูุฐู ุงูุฃุณุฆูุฉ ูุฌูุจ ุนููุง ุงููุตู ุงููุญุฏุฏุ ูุญูู ุชุฌุชูุน ูุฐู ุงูุฃุณุฆูุฉ ุจุฃุฌูุจุชูุง ูุฅููุง
                ุชููุฏู ููุฅุฌุงุจุฉ ุนูู ุงูุณุคุงู ุงูุนุงู ูุตูุงุนุฉ ุงููุฎูุต ุงูุนุงู ูููุชุงุจ.
              </p>
            </div>
          </div>
          <div v-if="(questions.length < 12 && status == 'stage_two' && auditable) || questions.length==0" class="d-flex align-items-center mt-3">
            <form @submit.prevent="submitQuestionForm" class="post-text ml-3 w-100 row">
              <div class="form-group col-6">
                <select v-model="v$.questionForm.starting_page.$model" class="form-select" data-trigger
                  name="choices-single-default" id="choices-single-default">
                  <option value="">ุงุฎุชุฑ ุตูุญุฉ ุงูุจุฏุงูุฉ</option>
                  <option v-for="(i, index) in book.pages" :key="index" :value="i">
                    {{ i }}
                  </option>
                </select>
                <small style="color: red" v-if="v$.questionForm.starting_page.$error"
                >{{pageError ? pageError :' ุงูุฑุฌุงุก ูู ุจุงุฏุฎุงู ุตูุญุฉ ุงูุจุฏุงูุฉ'}}</small
              >
              </div>
              <div class="form-group col-6">

                <select class="form-select" v-model="v$.questionForm.ending_page.$model" data-trigger
                  name="choices-single-default" id="choices-single-default">
                  <option value="">ุงุฎุชุฑ ุตูุญุฉ ุงูููุงูุฉ</option>
                  <option v-for="(i, index) in book.pages" :key="index" :value="i">
                    {{ i }}
                  </option>
                </select>
           <small style="color: red" v-if="v$.questionForm.ending_page.$error"
                >{{pageError ? pageError :' ุงูุฑุฌุงุก ูู ุจุงุฏุฎุงู ุตูุญุฉ ุงูููุงูุฉ'}}</small
              >
              </div>

              <div class="form-group">
                <textarea rows="5" placeholder="... ุงูุชุจ ุณุคุงููุง " class="rounded form-control" id="bookQuestion"
                  v-model="v$.questionForm.question.$model"></textarea>
                <small style="color:red;" v-if="v$.questionForm.question.$error">
                  ูุทููุง ูู ุจูุชุงุจุฉ ุณุคุงู ุนุฏุฏ ุญุฑููู ุจูู 100  ู 250
                </small>
              </div>
              <div>
                <h4>ููู ุฃุญุฏุฏ ุงูุงูุชุจุงุณุงุช</h4>
                <hr>
                <div class="col-12">
                  <p>
                    ูุนุชุจุฑ ุงูุงูุชุจุงุณ ูู ุงููุญุณูุงุช ุงูููุธูุฉุ ููู ุญูุธู ููุฃููุงู ุงููุฃุซูุฑุฉ ุนู ุงูุดุฎุตูุงุช ุงููุนุฑููุฉ ูุฃููุงูููุ ูุฎูุงู
                    ุงููุชุงุจ ุณุชุฌุฏ ุฃู ููุงู ุฌูู ูููุฉ ุฌุฏุง ุชูุฎุต ุฃููุงุฑูุง ุฃุณุงุณูุฉ ูู ุงููุชุงุจ. ูู ุจุชุญุฏูุฏ ุฃูู ุงูุงูุชุจุงุณุงุช ุฏุงุฎู ูุฐุง
                    ุงููุชุงุจ ูุชููู ุจุญูุธูุง ููู ุชุณุงุนุฏู ุนูู ุฅุฌุงุจุฉ ุงูุฃุณุฆูุฉ ุงููุนุฑููุฉ ูุชุนููู ุนูู ุงูุงุณุชุดูุงุฏ ุจูุง ูุฅุซุจุงุช ูุฌูุฉ ูุธุฑ
                    ุงููุงุชุจ </p>
                </div>
              </div>
              <div class="form-group">

                <textarea rows="5" placeholder="... ุงูุชุจ ุงูุชุจุงุณูุง " v-for="(v,index) in questionForm.quotes"
                  :key="index" class="rounded form-control mt-2" id="bookQuote" v-model="v.text">
                </textarea>
                <small style="color:red;" v-if="v$.questionForm.question.$error">
                 ูู ุจุงุฏุฎุงู ุงูุชุจุงุณ ูุงุญุฏ ุนูู ุงูุงูู ุนุฏุฏ ุญุฑููู ูุง ูุฒูุฏ ุนู 250

                </small>
                <hr>
                <a class="btn btn-primary rounded-pill mb-3 me-1" @click="addField(textarea, questionForm.quotes)">
                  ุงุถุงูุฉ ุงูุชุจุงุณ
                </a>
                <a class="btn btn-danger rounded-pill mb-3 me-1"
                  v-show="questionForm.quotes && questionForm.quotes.length > 1"
                  @click="removeField(index, questionForm.quotes)">
                  ุญุฐู ุงูุชุจุงุณ
                </a>


              </div>
              <input type="submit" value="ุฃุถุงูุฉ" href="javascript:void(0);" class="btn btn-primary d-block mt-3" />
            </form>
          </div>
          <hr />
          <div v-for="(question,index) in questions" :key="question.id">
            <ListQuestion :question="question" :index='index' :book="book" :user_book="user_book"/>
          </div>
          <iq-card v-if="questions.length >= 5 && auditable && status!='finished'">
            <template v-slot:body>
              <button class="btn btn-primary d-block w-100" @click="reviewQuestions">ุทูุจ ุชุฏููู</button>
            </template>
          </iq-card>
        </tab-content-item>
        <!-- END QUESTIONS -->

      </div>
    </div>
  </div>
</template>
<script>


import useVuelidate from "@vuelidate/core";
import ListQuestion from '../../../../components/Questions/ListQuestion.vue'
import { required, minLength, maxLength } from "@vuelidate/validators";
import generalInformationsServices from '../../../../api/generalInformationsServices'
import questionServices from '../../../../api/questionServices'

export default {
  setup() {
    return { v$: useVuelidate() };
  },
  name: 'Stage2',
  mounted() {
    this.getInformations();
    this.getQuestions();
  },
  components: {
    ListQuestion,
  },
  props: {
    book: {
      type: [Object],
      required: true,
    },
    status: {
      required: true
    },
    user_book: {
      type: [Object],
      required: true,
    },

  },
  validations() {
    return {
      generalInfromationsform: {
        general_question: {
          required,
          minLength: minLength(100),
          maxLength: maxLength(250) 
        },
        summary: {
          required,
          minLength: minLength(350),
          maxLength: maxLength(1800)

        },
      },
      questionForm: {
        question: {
          required,
          minLength: minLength(100),
          maxLength: maxLength(250)

        }, starting_page: {
          required 
        },
        ending_page: {
          required,valdiatePages:this.validatePages
        }, quotes: {
          required,
          minLength: minLength(1),
          $each: {
            text: {

              minLength: minLength(250)
            }
          }
        }
      }
    };
  },
  data() {
    return {
      auditable: false,
      pageError:'',
      questionForm: {
        question: '',
        starting_page: "",
        ending_page: "",
        user_book_id: this.user_book.id,
        quotes: [
          { text: '' }
        ]
      },
      generalInfromationsform: {
        general_question: '',
        summary: '',
        user_book_id: this.user_book.id,
      },
      generalInformations: [],
      questions: [],
      show: false,
    }
  },
  methods: {
    addField(value, fieldType) {

      fieldType.push({ text: "" });
    },
    removeField(index, fieldType) {
      fieldType.splice(index, 1);
    },
    async submitGenralInformationsForm() {
      this.v$.$touch();
      if (!this.v$.generalInfromationsform.$invalid) {
        this.generalInformations = await generalInformationsServices.addGeneralInformations(this.generalInfromationsform);
        this.v$.generalInfromationsform.general_question.$reset();
        this.v$.generalInfromationsform.summary.$reset();

      }
    },
    async submitQuestionForm() {
      this.v$.$touch();

      if (!this.v$.questionForm.$invalid) {
        const question = await questionServices.addQuestion(this.questionForm);
        this.questionForm.question = "";
        this.questionForm.starting_page = "";
        this.questionForm.ending_page = "";
        this.questionForm.quotes = [{ text: '' }];
        this.v$.questionForm.$reset()
        this.questions.push(question)
      }
    },
    async getInformations() {
      this.generalInformations = await generalInformationsServices.getGeneralInformations(this.user_book.id);
    },
    async getQuestions() {
      this.questions = await questionServices.getQuestions(this.user_book.id);
      this.auditable = this.questions.some(element => {
        if (element.status === 'rejected' || element.status === null) {
          return true;
        }
        return false;
      });
    },
    deleteGeneralInformation(id) {
      this.show = !this.show;
      const swalWithBootstrapButtons = this.$swal.mixin({
        customClass: {
          confirmButton: 'btn btn-primary btn-lg',
          cancelButton: 'btn btn-outline-primary btn-lg ms-2'
        },
        buttonsStyling: false
      })

      swalWithBootstrapButtons.fire({
        title: 'ูู ุฃูุช ูุชุฃูุฏุ',
        text: "ููุงููุชู ุชุนูู ุญุฐู ูุฐุง ุงูุณุคุงู ",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ูุนู ูู ุจุงูุญุฐู',
        cancelButtonText: 'ุชุฑุงุฌุน  ',
        showClass: {
          popup: 'animate__animated animate__zoomIn'
        },
        hideClass: {
          popup: 'animate__animated animate__zoomOut'
        }
      })
        .then((willDelete) => {
          if (willDelete.isConfirmed) {
            generalInformationsServices.deleteGeneralInformation(id)
              .then(response => {
                swalWithBootstrapButtons.fire({
                  title: 'ุชู ุงูุญุฐู',
                  text: 'ุชู ุญุฐู ุงูุณุคุงู',
                  icon: 'success',
                  showClass: {
                    popup: 'animate__animated animate__zoomIn'
                  },
                  hideClass: {
                    popup: 'animate__animated animate__zoomOut'
                  }
                })
                location.reload()
              })
              .catch(error => {
                console.log(error)
              })


          }
        })
    },
    updateGeneralInformation(id) {
      this.show = !this.show;
      this.$router.push({ path: `/general/update/${id}` })

    },
        validatePages(){
      const error =  parseInt(this.questionForm.starting_page) < parseInt(this.questionForm.ending_page)
      if(!error)this.pageError = 'ูุฌุจ ุงู ุชููู ุตูุญุฉ ุงูุจุฏุงูุฉ ุงูู ูู ุตูุญุฉ ุงูููุงูุฉ'
      else this.pageError = ''
      return error;
    },
    async reviewQuestions() {
      const swalWithBootstrapButtons = this.$swal.mixin({
        customClass: {
          confirmButton: 'btn btn-primary btn-lg',
          cancelButton: 'btn btn-outline-primary btn-lg ms-2'
        },
        buttonsStyling: false
      })
      swalWithBootstrapButtons.fire({
        title: 'ูู ุฃูุช ูุชุฃูุฏุ',
        text: "ูู ุญุงู ุทูุจู ููุชุฏููู ูู ููููู ุงุถุงูุฉ ุณุคุงู ุฌุฏูุฏ ุฃู ุงูุชุนุฏูู ุนูู ุงูุฃุณุฆูุฉ ุงูุชู ูุชุจุชูุง ",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ูุนู ูู ุจุทูุจ ุชุฏููู',
        cancelButtonText: 'ุชุฑุงุฌุน  ',
        showClass: {
          popup: 'animate__animated animate__zoomIn'
        },
        hideClass: {
          popup: 'animate__animated animate__zoomOut'
        }
      })
        .then((willDelete) => {
          if (willDelete.isConfirmed) {
            questionServices.reviewQuestion(this.user_book.id)
              .then(response => {
                swalWithBootstrapButtons.fire({
                  title: 'ุชู ุงูุงุฑุณุงู',
                  text: 'ุชู ุงุฑุณุงู ุทูุจู ููุชุฏููู',
                  icon: 'success',
                  showClass: {
                    popup: 'animate__animated animate__zoomIn'
                  },
                  hideClass: {
                    popup: 'animate__animated animate__zoomOut'
                  }
                })
                this.auditable = false;
              })
              .catch(error => {
                console.log(error)
              })
          }
        })
    },
    async reviewGeneralInformation() {
      const swalWithBootstrapButtons = this.$swal.mixin({
        customClass: {
          confirmButton: 'btn btn-primary btn-lg',
          cancelButton: 'btn btn-outline-primary btn-lg ms-2'
        },
        buttonsStyling: false
      })
      swalWithBootstrapButtons.fire({
        title: 'ูู ุฃูุช ูุชุฃูุฏุ',
        text: "ูู ุญุงู ุทูุจู ููุชุฏููู ูู ููููู ุงุถุงูุฉ ุณุคุงู ุฌุฏูุฏ ุฃู ุงูุชุนุฏูู ุนูู ุงูุชูุฎูุต ุงูุฐู ูุชุจุชู ",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'ูุนู ูู ุจุทูุจ ุชุฏููู',
        cancelButtonText: 'ุชุฑุงุฌุน  ',
        showClass: {
          popup: 'animate__animated animate__zoomIn'
        },
        hideClass: {
          popup: 'animate__animated animate__zoomOut'
        }
      })
        .then((willDelete) => {
          if (willDelete.isConfirmed) {
            generalInformationsServices.reviewGeneralInformation(this.user_book.id)
              .then(response => {
                swalWithBootstrapButtons.fire({
                  title: 'ุชู ุงูุงุฑุณุงู',
                  text: 'ุชู ุงุฑุณุงู ุทูุจู ููุชุฏููู',
                  icon: 'success',
                  showClass: {
                    popup: 'animate__animated animate__zoomIn'
                  },
                  hideClass: {
                    popup: 'animate__animated animate__zoomOut'
                  }
                })
                location.reload()
              })
              .catch(error => {
                console.log(error)
              })
          }
        })
    },
  },
}
</script>
